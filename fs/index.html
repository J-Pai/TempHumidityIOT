<html>
<head>
	<meta charset="utf-8"/>
	<title>IOT Temp & Humidity</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
	<script type="text/javascript">
		const HOST = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost" ?
		"http://192.168.0.104" : "";
		console.log("HOST:", HOST);

		window.chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)',
		};

		window.chartBgColors = {
			red: 'rgb(255, 99, 132, 0.2)',
			orange: 'rgb(255, 159, 64, 0.2)',
			yellow: 'rgb(255, 205, 86, 0.2)',
			green: 'rgb(75, 192, 192, 0.2)',
			blue: 'rgb(54, 162, 235, 0.2)',
			purple: 'rgb(153, 102, 255, 0.2)',
			grey: 'rgb(201, 203, 207, 0.2)',
		};


		$(document).ready(function () {
			let refreshCnt = 0;

			const tempDataset = {
				label: 'Temperature',
				borderColor: window.chartColors.red,
				backgroundColor: window.chartBgColors.red,
				fill: true,
				yAxisID: 'y-axis-1',
				data: [],
			};
			const humiDataset = {
				label: 'Humidity',
				borderColor: window.chartColors.blue,
				backgroundColor: window.chartBgColors.blue,
				fill: true,
				yAxisID: 'y-axis-2',
				data: [],
			};

			const ctx = $("#histTempHumi")[0].getContext("2d");
			const myChart = new Chart(ctx, {
				type: "line",
				data: {
					labels: [],
					datasets: [
						tempDataset,
						humiDataset,
					]
				},
				options: {
					title: {
						display: true,
						text: "Historical Temperature and Humidity"
					},
					scales: {
						yAxes: [{
							position: "left",
							id: "y-axis-1",
							scaleLabel: {
								labelString: "Temperature",
								display: true,
							}
						}, {
							position: "right",
							id: "y-axis-2",
							scaleLabel: {
								labelString: "Humidity (%)",
								display: true,
							}
						}],
					},
				},
			});

			/**
			* Make request for Temperature and Humidity and apply to HTML.
			*/
			function requestCurrTempHumi() {
				$('#refreshBtn').addClass('loading');
				$.ajax({
					url: HOST + "/dht",
					timeout: 20000,
				}).done(function (data) {
					const infoTempHumi = JSON.parse(data);
					const timestamp = moment(infoTempHumi.d).format("MMMM Do, YYYY - HH:mm:ss");
					const temp = parseFloat(infoTempHumi.t.substring(0, infoTempHumi.t.length - 1));
					tempType = infoTempHumi.t.includes("F") ? "&#176;F" : "&#176;C";
					const humi = parseFloat(infoTempHumi.h);
					$("#currTemp").html(temp + tempType);
					$("#currHumi").html(humi + "%");
					$("#currTimestamp").html(timestamp.toString());
					setTimeout(function() {
						requestHistTempHumi();
					}, 1000);
				}).fail(function (xhr, status) {
					console.error(xhr, status);
					$('#refreshBtn').removeClass('loading');
					$('#refreshBtn').addClass('red');
				});
			}

			/**
			* Request and Update Temperature and Humidity history graph.
			*/
			function requestHistTempHumi() {
				$('#refreshBtn').addClass('loading');
				$.ajax({
					url: HOST + "/dht/history",
					timeout: 20000,
				}).done(function (data) {
					const jsonStr = "[" + data + "]";
					const histTempHumi = JSON.parse(jsonStr);

					myChart.data.labels = [];
					tempDataset.data = [];
					humiDataset.data = [];

					histTempHumi.forEach(element => {
						const timestamp = moment(element.d).format("YYYY-MM-DD HH:mm:ss");
						const temp = parseFloat(element.t.substring(0, element.t.length - 1));
						myChart.options.scales.yAxes[0].scaleLabel.labelString = element.t.includes("F") ?
							"Temperature (" + String.fromCharCode(176) + "F)" :
							"Temperature (" + String.fromCharCode(176) + "C)";
						const humi = parseFloat(element.h);
						myChart.data.labels.push(timestamp);
						tempDataset.data.push(temp);
						humiDataset.data.push(humi);
					});
					myChart.update();
					$('#refreshBtn').removeClass('loading');
					$('#refreshBtn').removeClass('red');
				}).fail(function (xhr, status) {
					console.error(xhr, status);
					$('#refreshBtn').removeClass('loading');
					$('#refreshBtn').addClass('red');
				});
			}

			requestCurrTempHumi();

			$('#refreshBtn').on('click', function() {
				if(!$('#refreshBtn').hasClass('loading')) {
					requestCurrTempHumi();
				} else {
					console.log('Refresh in Progress!');
				}
			});
		});
	</script>
</head>
<body>
	<div class="ui container">
		<div class="ui basic vertical segment">
			<h1 class="ui header">IOT Temp and Humidity Tracker</h1>
		</div>
		<div class="ui container">
			<div class="ui segment">
				<div class="ui teal ribbon label" id="currTimestamp"></div>
				<button class="ui right floated icon green button" id='refreshBtn'>
					<i class="sync alternate icon"></i>
				</button>
				<div class="ui internally celled center aligned grid">
					<div class="middle aligned row">
						<div class="eight wide column">
							<div class="ui icon header">
								<i class="thermometer red icon"></i>
								<div id="currTemp">Temperature</div>
							</div>
						</div>
						<div class="eight wide column">
							<div class="ui icon header">
								<i class="tint blue icon"></i>
								<div id="currHumi">Humidity</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<canvas id="histTempHumi"></canvas>
	</div>
</body>
</html>